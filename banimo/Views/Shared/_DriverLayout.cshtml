


<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Orders List</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" />
    <!-- Bootstrap css-->
    <link rel="stylesheet" type="text/css" href="/AdminPanel/Portal/assets/css/vendors/bootstrap.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- local css  -->
    <link rel="stylesheet" type="text/css" href="/webAsset/deliver/app/Delivery/css/driver/index.css">
</head>
<body style="background-image: url('/webAsset/deliver/app/Delivery/imgs/bg-app.png'); ">


    <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="prnt" class="modal-body">

                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="wellcome" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="prnt" class="modal-body">
                    <p>Wellcome To Driver Panel</p>
                </div>
            </div>
        </div>
    </div>
  



    <div class="modal fade" id="AcceptOrder" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-body">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">New Order  ( <span id="theTarget">50</span> )</h5>
                        <button type="button" class="btn-close closeModal"></button>

                    </div>
                    <div class="modal-body">

                        <p><span>Sender Address:</span><br /><span id="senderAddress"></span></p>
                        <p><span>Receiver Address:</span><br /><span id="receiverAddress"></span></p>
                        <p id="orderID" style="display:none"></p>

                        <div class="button-box" style="text-align:center;margin-top:50px">
                            <button id="acceptOrder" type="button" class="btn  btn--yes btn-success" data-bs-original-title="" title="">Accept</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <audio style="display:none" id="song" src="~/notifsound.mp3"></audio>
    <nav class="navbar main-navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-chevron-left"></i>
            </a>

            <div>
                Orders List
            </div>

            @*<button class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#AppDrawer"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>*@

            <div class="offcanvas offcanvas-end mainDrawer"
                 tabindex="-1"
                 id="AppDrawer"
                 aria-labelledby="offcanvasRightLabel">
                <div class="offcanvas-header px-3">
                    <h5 class="offcanvas-title drawerTitle" id="offcanvasRightLabel">
                        <i class="bi bi-list mx-1"></i>
                        Start
                    </h5>
                    <button class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#AppDrawer" aria-label="Close"></button>

                </div>
                <div class="offcanvas-body">
                    <ul class="list-group list-group-flush siteMap">
                        <li class="list-group-item">
                            <a href="" class="links">
                                <i class="bi bi-house-fill mx-1"></i>
                                home
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="" class="links">
                                <i class="bi bi-person-lines-fill mx-1"></i>
                                Profile
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="" class="links">
                                <i class="bi bi-truck mx-1"></i>
                                Delevieries
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="" class="links">
                                <i class="bi bi-calendar-date-fill mx-1"></i>
                                Schdule
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="" class="links">
                                <i class="bi bi-bar-chart-fill mx-1"></i>
                                Statistics
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="" class="links">
                                <i class="bi bi-telephone-fill mx-1"></i>
                                Contact us
                            </a>
                        </li>


                    </ul>
                </div>
            </div>
        </div>
    </nav>



    <div class="container container-main">

        @RenderBody()


        <div class="app-bar">
            <a href="home" class="links appbar-icons d-flex flex-column text-center m-2 rounded px-2 py-1 ">
                <i class="bi bi-house-fill mx-1"></i>
                Home
            </a>


            <a href="list" class="links appbar-icons d-flex flex-column text-center m-2 rounded px-2 py-1 ">
                <i class="bi bi-qr-code-scan"></i>
                Orders
            </a>

            <a href="profile" class="links appbar-icons d-flex flex-column text-center m-2 rounded px-2 py-1 ">
                <i class="bi bi-person-fill"></i>
                Account
            </a>

            <a href="contactus"
               class="links appbar-icons d-flex flex-column text-center m-2 rounded px-2 py-1 ">
                <i class="bi bi-envelope-fill"></i>
                Contact Us
            </a>
        </div>


    </div>
    <script src="/AdminPanel/Portal/assets/js/jquery-3.6.0.min.js"></script>
    @*<script src="/AdminPanel/Portal/assets/js/bootstrap/bootstrap.bundle.min.js"></script>*@
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    @*<script src="~/webAsset/deliver/app/Delivery/js/popper.js"></script>*@

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin="">
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin="" />
    <script type="text/javascript">
        var mymap;
        var theMarker = {};

        function showLocation(lat, lon) {
            mymap = L.map('mapid', { attributionControl: false }).setView([lat, lon], 13);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoibWVyaW9saSIsImEiOiJja2p6dXhmdngwYmVvMnZwY2lyc2htNGxhIn0.Y9t__Bll6Fw9b9amb_rcHg',

            }).addTo(mymap);
            mymap.panTo(new L.LatLng(lat, lon));
            theMarker = L.marker([lat, lon]).addTo(mymap);

        }
        $("#mapid").height("250px");
    </script>
    <script>
        $(".showMap").click(function () {
            $('#mapModal').modal({ show: true });
            //$("#mapModal").modal('show');
            //$("#mapModal").addClass("show");
            var lat = $(this).attr('lat');
            var lon = $(this).attr('lon');
            if ($('#mapid').length) {
                $('#mapid').remove();
            }
            var el = "<div> <div id = 'mapid' style = 'margin-top:20px; width:100% ; height:300px'></div></div >"
            $("#prnt").append(el)
            setTimeout(
                function () {
                    showLocation(lat, lon);
                }, 2000);
           
            
        })
    </script>
    <script>
        $("#acceptOrder").click(function () {
            var id = $("#orderID").text().trim();
            $.ajax({
                url: '/Driver/AcceptOrder',
                dataType: 'html',
                data: {
                    id: id,
                },
                success: function (data) {

                    window.location.reload();

                },
                error: function () {

                }
            });
        })
    </script>

    <script src="~/Scripts/NoSleep.js"></script>
    <script>
        var noSleep = new NoSleep();
        noSleep.enable();
    </script>
    <script src="~/Scripts/Scripts/jquery.signalR-2.4.1.min.js"></script>

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                // timeout at 60000 milliseconds (60 seconds)
                var options = { timeout: 3000, enableHighAccuracy: true };
                navigator.geolocation.getCurrentPosition
                    (ConnectToSignal, errorHandler, options);

            } else {
                alert("Sorry, browser does not support geolocation!");
            }
        }
        function errorHandler() {
           let lat = "0";
            let lon = "0";
            // Reference the auto-generated proxy for the hub.
            var hub = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.

            hub.client.wellcom = function () {
                //document.getElementById('#song').play();

                $("#wellcome").modal('toggle');
                $("#wellcome").addClass("show");

            };
            hub.client.newOrder = function (senderaddress, receiveraddress, senderlat, senderlon, receiverlat, receiverlon,id) {

                //alert("dddd");
                if ($('#AcceptOrder').hasClass('show')) {
                    console.log("already has")
                }
                else {
                    var myAudio = $("#song")[0];
                    myAudio.play();
                    $("#senderAddress").text(senderaddress);
                    $("#receiverAddress").text(receiveraddress);
                    $("#orderID").text(id);
                    $("#AcceptOrder").modal("toggle");
                    $("#AcceptOrder").addClass("show");
                    var timer = setInterval(function () {

                        var count = parseInt($('#theTarget').html());
                        if (count !== 0) {
                            $('#theTarget').html(count - 1);
                        } else {
                            clearInterval(timer);
                            $("#AcceptOrder").modal("toggle");
                            $("#AcceptOrder").removeClass("show");
                        }
                    }, 1000);
                }



            };
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
               hub.server.joinDeliver('@Model.type','@Model.username',  '@Model.status', lat, lon);
            });
        }
        function ConnectToSignal(position) {
            let lat = position.coords.latitude;
            let lon = position.coords.longitude;
            // Reference the auto-generated proxy for the hub.
            var hub = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.

            hub.client.wellcom = function () {
                //document.getElementById('#song').play();

                $("#wellcome").modal('toggle');
                $("#wellcome").addClass("show");

            };
            hub.client.newOrder = function (senderaddress, receiveraddress, senderlat, senderlon, receiverlat, receiverlon, id) {

                //alert("dddd");
                if ($('#AcceptOrder').hasClass('show')) {
                    console.log("already has")
                }
                else {
                    var myAudio = $("#song")[0];
                    myAudio.play();
                    $("#senderAddress").text(senderaddress);
                    $("#receiverAddress").text(receiveraddress);
                    $("#orderID").text(id);
                    $("#AcceptOrder").modal("toggle");
                    $("#AcceptOrder").addClass("show");
                    var timer = setInterval(function () {

                        var count = parseInt($('#theTarget').html());
                        if (count !== 0) {
                            $('#theTarget').html(count - 1);
                        } else {
                            clearInterval(timer);
                            $("#AcceptOrder").modal("toggle");
                            $("#AcceptOrder").removeClass("show");
                        }
                    }, 1000);
                }



            };

            // Get the user name and store it to prepend to messages.
            //$('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {

                hub.server.joinDeliver('@Model.type','@Model.username',  '@Model.status', lat, lon);
                @*$('#acceptOrder').click(function () {
                    // Call the Send method on the hub.
                    hub.server.changeUserStatus('@token');
                });*@
            });
        }

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
        getLocation();
    </script>
    <script>

        $(".closeModal").click(function () {
            
                $(this).closest('.modal').modal('toggle');
        });

    </script>

    @RenderSection("scripts", required: false)
</body>

</html>


